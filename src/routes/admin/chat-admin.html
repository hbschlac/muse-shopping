<!doctype html>
<html lang="en">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>Muse Chat Admin</title>
  <style>
    :root {
      color-scheme: light;
      --bg: #f4f1ed;
      --ink: #221f1b;
      --muted: #6f655b;
      --accent: #0f766e;
      --panel: #ffffff;
      --border: #e2dcd4;
      --subtle: #faf7f2;
      --chip: #efe7de;
    }
    * { box-sizing: border-box; }
    body {
      margin: 0;
      font-family: "GT Walsheim", "Avenir Next", "Segoe UI", sans-serif;
      background: radial-gradient(circle at top left, #fefaf4 0%, #f4efe7 55%, #efe8dd 100%);
      color: var(--ink);
    }
    .wrap {
      max-width: 1240px;
      margin: 36px auto 60px;
      padding: 24px;
    }
    header {
      display: flex;
      justify-content: space-between;
      align-items: baseline;
      gap: 24px;
      margin-bottom: 20px;
    }
    h1 { margin: 0; font-size: 28px; }
    p { margin: 4px 0 0; color: var(--muted); }
    .grid {
      display: grid;
      grid-template-columns: 1fr 1fr;
      gap: 20px;
    }
    .panel {
      background: var(--panel);
      border: 1px solid var(--border);
      border-radius: 16px;
      padding: 18px;
      box-shadow: 0 10px 30px rgba(0,0,0,0.06);
    }
    .panel h3 { margin-top: 0; }
    label { display: block; font-size: 13px; color: var(--muted); margin-bottom: 6px; }
    input, textarea, select {
      width: 100%;
      border: 1px solid var(--border);
      border-radius: 12px;
      padding: 10px 12px;
      font-size: 14px;
      font-family: inherit;
      background: #fff;
    }
    textarea { min-height: 110px; resize: vertical; }
    .row { margin-bottom: 12px; }
    .actions { display: flex; gap: 10px; flex-wrap: wrap; }
    button {
      border: none;
      background: var(--accent);
      color: white;
      padding: 10px 16px;
      border-radius: 999px;
      cursor: pointer;
      font-weight: 600;
    }
    button.secondary { background: #efe7de; color: var(--ink); }
    button.ghost { background: transparent; color: var(--ink); border: 1px solid var(--border); }
    pre {
      background: #121212;
      color: #e7e7e7;
      padding: 14px;
      border-radius: 12px;
      overflow: auto;
      font-size: 12px;
    }
    .item {
      display: grid;
      grid-template-columns: 72px 1fr;
      gap: 12px;
      padding: 10px 0;
      border-bottom: 1px solid var(--border);
    }
    .item:last-child { border-bottom: none; }
    .thumb {
      width: 72px; height: 90px; border-radius: 10px; background: #e7e2dc; overflow: hidden;
      display: flex; align-items: center; justify-content: center; color: var(--muted); font-size: 12px;
    }
    .pill { display: inline-block; background: var(--chip); padding: 3px 8px; border-radius: 999px; font-size: 11px; margin-right: 6px; }

    .table {
      width: 100%;
      border-collapse: collapse;
      font-size: 13px;
    }
    .table th, .table td {
      text-align: left;
      padding: 8px 10px;
      border-bottom: 1px solid var(--border);
      vertical-align: top;
    }
    .table th { color: var(--muted); font-weight: 600; font-size: 12px; text-transform: uppercase; letter-spacing: 0.04em; }
    .table tr:hover { background: var(--subtle); cursor: pointer; }
    .chip { background: var(--chip); border-radius: 999px; padding: 2px 8px; display: inline-block; font-size: 11px; }
    .mono { font-family: "SFMono-Regular", "Menlo", "Monaco", monospace; font-size: 12px; }

    .message-list {
      max-height: 380px;
      overflow: auto;
      padding-right: 4px;
    }
    .message {
      border: 1px solid var(--border);
      border-radius: 12px;
      padding: 10px 12px;
      margin-bottom: 10px;
      background: #fff;
    }
    .message.assistant { border-left: 4px solid var(--accent); }
    .message.user { border-left: 4px solid #d4a373; }
    .message .meta { color: var(--muted); font-size: 11px; margin-bottom: 6px; }

    @media (max-width: 980px) {
      .grid { grid-template-columns: 1fr; }
    }
  </style>
</head>
<body>
  <div class="wrap">
    <header>
      <div>
        <h1>Muse Chat Admin</h1>
        <p>Scaffolding view for sessions, transcripts, and live chat runs.</p>
      </div>
    </header>

    <div class="grid">
      <section class="panel">
        <h3>Run a Chat</h3>
        <div class="row">
          <label>Admin Bearer Token</label>
          <input id="token" placeholder="Paste admin JWT" />
        </div>
        <div class="row">
          <label>Session ID (optional)</label>
          <input id="sessionId" placeholder="Leave blank to start new session" />
        </div>
        <div class="row">
          <label>Message</label>
          <textarea id="message" placeholder="Ask Muse for editorial guidance or a curated search..."></textarea>
        </div>
        <div class="row">
          <label>History (optional JSON array)</label>
          <textarea id="history" placeholder='[{"role":"user","content":"I want a summer capsule"}]'></textarea>
        </div>
        <div class="row">
          <label>Context (optional JSON)</label>
          <textarea id="context" placeholder='{"channel":"admin","locale":"en-US"}'></textarea>
        </div>
        <div class="actions">
          <button id="runBtn">Run Chat</button>
          <button class="secondary" id="clearBtn">Clear</button>
        </div>
      </section>

      <section class="panel">
        <h3>Response</h3>
        <pre id="response">Waiting for request...</pre>
        <div id="items"></div>
      </section>
    </div>

    <div class="grid" style="margin-top:20px;">
      <section class="panel">
        <div class="actions" style="justify-content: space-between; margin-bottom: 12px;">
          <div>
            <strong>Analytics Overview</strong>
            <div style="color: var(--muted); font-size: 12px;">Intent volume + top queries</div>
          </div>
          <div class="actions">
            <input id="analyticsFrom" placeholder="From (YYYY-MM-DD)" />
            <input id="analyticsTo" placeholder="To (YYYY-MM-DD)" />
            <button class="ghost" id="refreshAnalytics">Refresh</button>
          </div>
        </div>
        <div class="row" style="display:grid; grid-template-columns: 1fr 1fr; gap: 12px;">
          <div>
            <div class="chip" id="totalMessages">Total messages: 0</div>
          </div>
        </div>
        <div class="row">
          <table class="table" id="intentTable">
            <thead>
              <tr><th>Intent</th><th>Count</th></tr>
            </thead>
            <tbody></tbody>
          </table>
        </div>
        <div class="row">
          <table class="table" id="queryTable">
            <thead>
              <tr><th>Top Query</th><th>Count</th></tr>
            </thead>
            <tbody></tbody>
          </table>
        </div>
      </section>

      <section class="panel">
        <div class="actions" style="justify-content: space-between; margin-bottom: 12px;">
          <div>
            <strong>Flag Queue</strong>
            <div style="color: var(--muted); font-size: 12px;">Open flags needing review</div>
          </div>
          <div class="actions">
            <button class="ghost" id="refreshFlags">Refresh</button>
          </div>
        </div>
        <table class="table" id="flagTable">
          <thead>
            <tr><th>Flag</th><th>Session</th><th>Reason</th><th>Created</th><th>Action</th></tr>
          </thead>
          <tbody></tbody>
        </table>
      </section>

      <section class="panel">
        <div class="actions" style="justify-content: space-between; margin-bottom: 12px;">
          <div>
            <strong>Review Queue</strong>
            <div style="color: var(--muted); font-size: 12px;">Human-in-the-loop review items</div>
          </div>
          <div class="actions">
            <button class="ghost" id="refreshReviews">Refresh</button>
          </div>
        </div>
        <table class="table" id="reviewTable">
          <thead>
            <tr><th>ID</th><th>Session</th><th>Reason</th><th>Priority</th><th>Created</th></tr>
          </thead>
          <tbody></tbody>
        </table>
      </section>

      <section class="panel">
        <div class="actions" style="justify-content: space-between; margin-bottom: 12px;">
          <div>
            <strong>Profile Diffs</strong>
            <div style="color: var(--muted); font-size: 12px;">Before/after snapshots from chat</div>
          </div>
          <div class="actions">
            <button class="ghost" id="refreshDiffs">Refresh</button>
          </div>
        </div>
        <table class="table" id="diffTable">
          <thead>
            <tr><th>User</th><th>Created</th><th>View</th></tr>
          </thead>
          <tbody></tbody>
        </table>
        <div class="row" style="margin-top: 12px;">
          <strong>Diff Snapshot</strong>
          <pre id="diffPreview" style="margin-top: 8px;">Select a diff row to preview.</pre>
        </div>
      </section>

      <section class="panel">
        <div class="actions" style="justify-content: space-between; margin-bottom: 12px;">
          <div>
            <strong>Profile Versions</strong>
            <div style="color: var(--muted); font-size: 12px;">Preview + restore stored profile snapshots</div>
          </div>
          <div class="actions">
            <button class="ghost" id="refreshVersions">Refresh</button>
          </div>
        </div>
        <div class="row" style="display:grid; grid-template-columns: 1fr 1fr; gap: 12px;">
          <div>
            <label>User ID</label>
            <input id="versionUserId" placeholder="Enter user id" />
          </div>
          <div style="display:flex; align-items:end;">
            <button class="ghost" id="loadVersionsBtn">Load Versions</button>
          </div>
        </div>
        <table class="table" id="versionsTable">
          <thead>
            <tr><th>ID</th><th>Created</th><th>Action</th></tr>
          </thead>
          <tbody></tbody>
        </table>
        <div class="row" style="margin-top: 12px;">
          <strong>Preview Diff (Current vs Selected)</strong>
          <pre id="profilePreview" style="margin-top: 8px;">Select a version to preview changes.</pre>
        </div>
      </section>

      <section class="panel">
        <div class="actions" style="justify-content: space-between; margin-bottom: 12px;">
          <div>
            <strong>Job Dashboard</strong>
            <div style="color: var(--muted); font-size: 12px;">Run maintenance jobs and see recent runs</div>
          </div>
          <div class="actions">
            <button class="ghost" id="refreshJobRuns">Refresh</button>
          </div>
        </div>
        <div class="row" style="display:grid; grid-template-columns: 1fr 1fr; gap: 12px;">
          <div>
            <label>Job</label>
            <select id="jobSelect">
              <option value="preference_decay">Preference Decay</option>
              <option value="session_summary">Session Summaries</option>
            </select>
          </div>
          <div style="display:flex; align-items:end;">
            <button class="ghost" id="runJobBtn">Run Job</button>
          </div>
        </div>
        <table class="table" id="jobRunsTable">
          <thead>
            <tr><th>Job</th><th>Status</th><th>Run At</th><th>Meta</th></tr>
          </thead>
          <tbody></tbody>
        </table>
      </section>

      <section class="panel">
        <div class="actions" style="justify-content: space-between; margin-bottom: 12px;">
          <div>
            <strong>Chat Sessions</strong>
            <div style="color: var(--muted); font-size: 12px;">Latest sessions with last message preview</div>
          </div>
          <div class="actions">
            <input id="sessionLimit" type="number" min="1" max="200" value="50" style="width:110px" />
            <button class="ghost" id="refreshSessions">Refresh</button>
          </div>
        </div>
        <div class="row" style="display:grid; grid-template-columns: 1fr 1fr; gap: 12px;">
          <div>
            <label>User ID</label>
            <input id="filterUserId" placeholder="Optional" />
          </div>
          <div>
            <label>Keyword</label>
            <input id="filterQuery" placeholder="Search message text" />
          </div>
        </div>
        <div class="row" style="display:grid; grid-template-columns: 1fr 1fr; gap: 12px;">
          <div>
            <label>From (ISO)</label>
            <input id="filterFrom" placeholder="2026-02-01" />
          </div>
          <div>
            <label>To (ISO)</label>
            <input id="filterTo" placeholder="2026-02-03" />
          </div>
        </div>
        <table class="table" id="sessionsTable">
          <thead>
            <tr>
              <th>ID</th>
              <th>User</th>
              <th>Messages</th>
              <th>Last Message</th>
              <th>Updated</th>
            </tr>
          </thead>
          <tbody></tbody>
        </table>
      </section>

      <section class="panel">
        <div class="actions" style="justify-content: space-between; margin-bottom: 12px;">
          <div>
            <strong>Session Transcript</strong>
            <div style="color: var(--muted); font-size: 12px;">Select a session to load messages.</div>
          </div>
          <div class="actions">
            <button class="ghost" id="loadSessionBtn">Load Session</button>
          </div>
        </div>
        <div class="row">
          <label>Selected Session ID</label>
          <input id="selectedSession" placeholder="Click a row in the sessions table" />
        </div>
        <div class="row">
          <label>Session Label</label>
          <input id="sessionLabel" placeholder="e.g. size-issue, trend-request" />
        </div>
        <div class="actions">
          <button class="ghost" id="saveLabelBtn">Save Label</button>
        </div>
        <div class="message-list" id="messageList"></div>
      </section>
    </div>
  </div>

  <script>
    const runBtn = document.getElementById('runBtn');
    const clearBtn = document.getElementById('clearBtn');
    const responseEl = document.getElementById('response');
    const itemsEl = document.getElementById('items');
    const sessionsTableBody = document.querySelector('#sessionsTable tbody');
    const refreshSessionsBtn = document.getElementById('refreshSessions');
    const sessionLimitInput = document.getElementById('sessionLimit');
    const selectedSessionInput = document.getElementById('selectedSession');
    const loadSessionBtn = document.getElementById('loadSessionBtn');
    const messageList = document.getElementById('messageList');
    const filterUserId = document.getElementById('filterUserId');
    const filterQuery = document.getElementById('filterQuery');
    const filterFrom = document.getElementById('filterFrom');
    const filterTo = document.getElementById('filterTo');
    const analyticsFrom = document.getElementById('analyticsFrom');
    const analyticsTo = document.getElementById('analyticsTo');
    const refreshAnalytics = document.getElementById('refreshAnalytics');
    const intentTableBody = document.querySelector('#intentTable tbody');
    const queryTableBody = document.querySelector('#queryTable tbody');
    const totalMessages = document.getElementById('totalMessages');
    const refreshFlags = document.getElementById('refreshFlags');
    const flagTableBody = document.querySelector('#flagTable tbody');
    const refreshReviews = document.getElementById('refreshReviews');
    const reviewTableBody = document.querySelector('#reviewTable tbody');
    const refreshDiffs = document.getElementById('refreshDiffs');
    const diffTableBody = document.querySelector('#diffTable tbody');
    const diffPreview = document.getElementById('diffPreview');
    const refreshVersions = document.getElementById('refreshVersions');
    const versionUserId = document.getElementById('versionUserId');
    const loadVersionsBtn = document.getElementById('loadVersionsBtn');
    const versionsTableBody = document.querySelector('#versionsTable tbody');
    const profilePreview = document.getElementById('profilePreview');
    const refreshJobRuns = document.getElementById('refreshJobRuns');
    const jobSelect = document.getElementById('jobSelect');
    const runJobBtn = document.getElementById('runJobBtn');
    const jobRunsTableBody = document.querySelector('#jobRunsTable tbody');
    const sessionLabel = document.getElementById('sessionLabel');
    const saveLabelBtn = document.getElementById('saveLabelBtn');

    function authHeaders() {
      const token = document.getElementById('token').value.trim();
      return token ? { Authorization: `Bearer ${token}` } : {};
    }

    function safeJson(text, fallback) {
      try { return JSON.parse(text); } catch { return fallback; }
    }

    function computeDiff(before, after, path = '') {
      const changes = [];
      const beforeVal = before ?? null;
      const afterVal = after ?? null;

      const isObject = (val) => val && typeof val === 'object' && !Array.isArray(val);

      if (isObject(beforeVal) && isObject(afterVal)) {
        const keys = new Set([...Object.keys(beforeVal), ...Object.keys(afterVal)]);
        keys.forEach((key) => {
          const nextPath = path ? `${path}.${key}` : key;
          changes.push(...computeDiff(beforeVal[key], afterVal[key], nextPath));
        });
        return changes;
      }

      if (Array.isArray(beforeVal) || Array.isArray(afterVal)) {
        if (JSON.stringify(beforeVal) !== JSON.stringify(afterVal)) {
          changes.push({ path, before: beforeVal, after: afterVal });
        }
        return changes;
      }

      if (beforeVal !== afterVal) {
        changes.push({ path, before: beforeVal, after: afterVal });
      }
      return changes;
    }

    function renderDiff(previewEl, before, after) {
      const changes = computeDiff(before, after);
      if (!changes.length) {
        previewEl.textContent = 'No changes detected.';
        return;
      }
      previewEl.textContent = JSON.stringify(changes, null, 2);
    }

    function renderItems(items) {
      itemsEl.innerHTML = '';
      if (!items || items.length === 0) return;

      items.forEach((item) => {
        const row = document.createElement('div');
        row.className = 'item';
        const thumb = document.createElement('div');
        thumb.className = 'thumb';
        if (item.primary_image_url) {
          const img = document.createElement('img');
          img.src = item.primary_image_url;
          img.alt = item.canonical_name || 'item';
          img.style.width = '100%';
          img.style.height = '100%';
          img.style.objectFit = 'cover';
          thumb.innerHTML = '';
          thumb.appendChild(img);
        } else {
          thumb.textContent = 'No image';
        }

        const body = document.createElement('div');
        body.innerHTML = `
          <div><strong>${item.canonical_name || 'Untitled'}</strong></div>
          <div>${item.brand_name || ''}</div>
          <div>
            <span class="pill">${item.category || 'category'}</span>
            <span class="pill">${item.sale_price || item.min_price || 'price n/a'}</span>
          </div>
        `;

        row.appendChild(thumb);
        row.appendChild(body);
        itemsEl.appendChild(row);
      });
    }

    async function fetchSessions() {
      const limit = parseInt(sessionLimitInput.value || '50', 10);
      const params = new URLSearchParams({ limit: String(limit) });
      if (filterUserId.value.trim()) params.set('user_id', filterUserId.value.trim());
      if (filterQuery.value.trim()) params.set('q', filterQuery.value.trim());
      if (filterFrom.value.trim()) params.set('from', filterFrom.value.trim());
      if (filterTo.value.trim()) params.set('to', filterTo.value.trim());

      const res = await fetch(`/api/v1/admin/chat/sessions?${params.toString()}`, {
        headers: authHeaders()
      });
      const data = await res.json();
      return data.data || [];
    }

    async function loadFlags() {
      const res = await fetch('/api/v1/admin/chat/flags/queue', {
        headers: authHeaders()
      });
      const data = await res.json();
      const flags = data.data || [];
      flagTableBody.innerHTML = '';
      if (!flags.length) {
        const tr = document.createElement('tr');
        tr.innerHTML = '<td colspan="5">No open flags</td>';
        flagTableBody.appendChild(tr);
        return;
      }
      flags.forEach((flag) => {
        const tr = document.createElement('tr');
        tr.innerHTML = `
          <td class="mono">${flag.id}</td>
          <td class="mono">${flag.session_id}</td>
          <td>${flag.reason}</td>
          <td>${new Date(flag.created_at).toLocaleString()}</td>
          <td><button class="ghost" data-flag="${flag.id}">Resolve</button></td>
        `;
        tr.querySelector('button').addEventListener('click', async () => {
          await fetch(`/api/v1/admin/chat/flags/${flag.id}/resolve`, {
            method: 'POST',
            headers: authHeaders()
          });
          await loadFlags();
        });
        flagTableBody.appendChild(tr);
      });
    }

    async function loadAnalytics() {
      const params = new URLSearchParams();
      if (analyticsFrom.value.trim()) params.set('from', analyticsFrom.value.trim());
      if (analyticsTo.value.trim()) params.set('to', analyticsTo.value.trim());

      const res = await fetch(`/api/v1/admin/chat/analytics?${params.toString()}`, {
        headers: authHeaders()
      });
      const data = await res.json();
      const payload = data.data || { total_messages: 0, intents: [], top_queries: [] };

      totalMessages.textContent = `Total messages: ${payload.total_messages}`;
      intentTableBody.innerHTML = '';
      payload.intents.forEach((row) => {
        const tr = document.createElement('tr');
        tr.innerHTML = `<td>${row.intent}</td><td>${row.count}</td>`;
        intentTableBody.appendChild(tr);
      });

      queryTableBody.innerHTML = '';
      payload.top_queries.forEach((row) => {
        const tr = document.createElement('tr');
        tr.innerHTML = `<td>${row.query || '-'}</td><td>${row.count}</td>`;
        queryTableBody.appendChild(tr);
      });
    }

    async function loadProfileDiffs() {
      const res = await fetch('/api/v1/admin/chat/profile-diffs', {
        headers: authHeaders()
      });
      const data = await res.json();
      const diffs = data.data || [];
      diffTableBody.innerHTML = '';
      if (!diffs.length) {
        const tr = document.createElement('tr');
        tr.innerHTML = '<td colspan="3">No profile diffs yet</td>';
        diffTableBody.appendChild(tr);
        return;
      }
      diffs.forEach((diff) => {
        const tr = document.createElement('tr');
        const button = document.createElement('button');
        button.className = 'ghost';
        button.textContent = 'Preview';
        button.addEventListener('click', () => {
          const before = typeof diff.before_profile === 'string' ? safeJson(diff.before_profile, {}) : (diff.before_profile || {});
          const after = typeof diff.after_profile === 'string' ? safeJson(diff.after_profile, {}) : (diff.after_profile || {});
          renderDiff(diffPreview, before, after);
        });
        tr.innerHTML = `<td class="mono">${diff.user_id}</td><td>${new Date(diff.created_at).toLocaleString()}</td>`;
        const td = document.createElement('td');
        td.appendChild(button);
        tr.appendChild(td);
        diffTableBody.appendChild(tr);
      });
    }

    async function loadProfileVersions() {
      const userId = versionUserId.value.trim();
      if (!userId) {
        profilePreview.textContent = 'Enter a user id to load versions.';
        return;
      }
      const params = new URLSearchParams({ user_id: userId });
      const res = await fetch(`/api/v1/admin/chat/profile-versions?${params.toString()}`, {
        headers: authHeaders()
      });
      const data = await res.json();
      const versions = data.data || [];
      versionsTableBody.innerHTML = '';
      if (!versions.length) {
        const tr = document.createElement('tr');
        tr.innerHTML = '<td colspan="3">No profile versions yet</td>';
        versionsTableBody.appendChild(tr);
        return;
      }
      versions.forEach((version) => {
        const tr = document.createElement('tr');
        tr.innerHTML = `<td class="mono">${version.id}</td><td>${new Date(version.created_at).toLocaleString()}</td>`;
        const td = document.createElement('td');
        const previewBtn = document.createElement('button');
        previewBtn.className = 'ghost';
        previewBtn.textContent = 'Preview';
        previewBtn.addEventListener('click', async () => {
          await previewProfileVersion(version.id, userId);
        });
        const restoreBtn = document.createElement('button');
        restoreBtn.className = 'ghost';
        restoreBtn.style.marginLeft = '6px';
        restoreBtn.textContent = 'Restore';
        restoreBtn.addEventListener('click', async () => {
          if (!confirm('Restore this profile version?')) return;
          await restoreProfileVersion(version.id, userId);
        });
        td.appendChild(previewBtn);
        td.appendChild(restoreBtn);
        tr.appendChild(td);
        versionsTableBody.appendChild(tr);
      });
    }

    async function previewProfileVersion(versionId, userId) {
      const params = new URLSearchParams({ user_id: userId });
      const res = await fetch(`/api/v1/admin/chat/profile-versions/${versionId}/preview?${params.toString()}`, {
        headers: authHeaders()
      });
      const data = await res.json();
      if (!data.success) {
        profilePreview.textContent = data.error || 'Unable to preview version.';
        return;
      }
      const current = data.data.current || {};
      const version = data.data.version || {};
      const snapshot = typeof version.snapshot === 'string' ? safeJson(version.snapshot, {}) : (version.snapshot || {});
      renderDiff(profilePreview, current, snapshot);
    }

    async function restoreProfileVersion(versionId, userId) {
      const res = await fetch(`/api/v1/admin/chat/profile-versions/${versionId}/restore`, {
        method: 'POST',
        headers: {
          'Content-Type': 'application/json',
          ...authHeaders()
        },
        body: JSON.stringify({ user_id: parseInt(userId, 10) })
      });
      const data = await res.json();
      if (!data.success) {
        profilePreview.textContent = data.error || 'Unable to restore version.';
        return;
      }
      profilePreview.textContent = 'Profile restored. Reload versions to preview updated changes.';
    }

    async function loadJobRuns() {
      const res = await fetch('/api/v1/admin/chat/jobs/runs?limit=10', {
        headers: authHeaders()
      });
      const data = await res.json();
      const runs = data.data || [];
      jobRunsTableBody.innerHTML = '';
      if (!runs.length) {
        const tr = document.createElement('tr');
        tr.innerHTML = '<td colspan="4">No job runs recorded yet</td>';
        jobRunsTableBody.appendChild(tr);
        return;
      }
      runs.forEach((run) => {
        const tr = document.createElement('tr');
        tr.innerHTML = `
          <td>${run.job_name}</td>
          <td>${run.status}</td>
          <td>${new Date(run.run_at).toLocaleString()}</td>
          <td class="mono">${run.metadata ? JSON.stringify(run.metadata) : '-'}</td>
        `;
        jobRunsTableBody.appendChild(tr);
      });
    }

    async function runJob() {
      const job = jobSelect.value;
      const res = await fetch('/api/v1/admin/chat/jobs/run', {
        method: 'POST',
        headers: {
          'Content-Type': 'application/json',
          ...authHeaders()
        },
        body: JSON.stringify({ job })
      });
      const data = await res.json();
      if (!data.success) {
        alert(data.error || 'Job run failed');
      }
      await loadJobRuns();
    }

    function renderSessions(sessions) {
      sessionsTableBody.innerHTML = '';
      if (!sessions || sessions.length === 0) {
        const row = document.createElement('tr');
        row.innerHTML = `<td colspan="5">No sessions found.</td>`;
        sessionsTableBody.appendChild(row);
        return;
      }
      sessions.forEach((session) => {
        const row = document.createElement('tr');
        row.innerHTML = `
          <td class="mono">${session.id}</td>
          <td>${session.user_id || '-'}</td>
          <td>${session.message_count}</td>
          <td>${session.last_message || ''}</td>
          <td>${new Date(session.updated_at).toLocaleString()}</td>
        `;
        row.addEventListener('click', () => {
          selectedSessionInput.value = session.id;
          sessionLabel.value = session.label || '';
        });
        sessionsTableBody.appendChild(row);
      });
    }

    async function loadSessionMessages() {
      const sessionId = selectedSessionInput.value.trim();
      if (!sessionId) return;

      const res = await fetch(`/api/v1/admin/chat/sessions/${sessionId}`, {
        headers: authHeaders()
      });
      const data = await res.json();
      const messages = data.data || [];
      messageList.innerHTML = '';

      messages.forEach((msg) => {
        const div = document.createElement('div');
        div.className = `message ${msg.role}`;
        div.innerHTML = `
          <div class="meta">${msg.role} Â· ${new Date(msg.created_at).toLocaleString()}</div>
          <div>${msg.content}</div>
        `;
        messageList.appendChild(div);
      });
    }

    async function loadReviews() {
      const res = await fetch('/api/v1/admin/chat/reviews?status=open', {
        headers: authHeaders()
      });
      const data = await res.json();
      const reviews = data.data || [];
      reviewTableBody.innerHTML = '';
      if (!reviews.length) {
        const tr = document.createElement('tr');
        tr.innerHTML = '<td colspan="5">No review items</td>';
        reviewTableBody.appendChild(tr);
        return;
      }
      reviews.forEach((review) => {
        const tr = document.createElement('tr');
        tr.innerHTML = `
          <td class="mono">${review.id}</td>
          <td class="mono">${review.session_id}</td>
          <td>${review.reason}</td>
          <td>${review.priority}</td>
          <td>${new Date(review.created_at).toLocaleString()}</td>
        `;
        reviewTableBody.appendChild(tr);
      });
    }

    runBtn.addEventListener('click', async () => {
      const token = document.getElementById('token').value.trim();
      const sessionId = document.getElementById('sessionId').value.trim();
      const message = document.getElementById('message').value.trim();
      const history = safeJson(document.getElementById('history').value.trim(), []);
      const context = safeJson(document.getElementById('context').value.trim(), {});

      responseEl.textContent = 'Loading...';
      itemsEl.innerHTML = '';

      const payload = { message, history, context };
      if (sessionId) payload.session_id = sessionId;

      const res = await fetch('/api/v1/chat', {
        method: 'POST',
        headers: {
          'Content-Type': 'application/json',
          ...(token ? { Authorization: `Bearer ${token}` } : {})
        },
        body: JSON.stringify(payload)
      });

      const data = await res.json();
      responseEl.textContent = JSON.stringify(data, null, 2);
      if (data && data.data && data.data.items) {
        renderItems(data.data.items);
      }
      if (data && data.data && data.data.session_id) {
        document.getElementById('sessionId').value = data.data.session_id;
      }
    });

    clearBtn.addEventListener('click', () => {
      responseEl.textContent = 'Waiting for request...';
      itemsEl.innerHTML = '';
      document.getElementById('message').value = '';
      document.getElementById('history').value = '';
      document.getElementById('context').value = '';
    });

    refreshSessionsBtn.addEventListener('click', async () => {
      const sessions = await fetchSessions();
      renderSessions(sessions);
    });

    refreshFlags.addEventListener('click', async () => {
      await loadFlags();
    });

    refreshAnalytics.addEventListener('click', async () => {
      await loadAnalytics();
    });

    refreshReviews.addEventListener('click', async () => {
      await loadReviews();
    });

    refreshDiffs.addEventListener('click', async () => {
      await loadProfileDiffs();
    });

    loadVersionsBtn.addEventListener('click', async () => {
      await loadProfileVersions();
    });

    refreshVersions.addEventListener('click', async () => {
      await loadProfileVersions();
    });

    refreshJobRuns.addEventListener('click', async () => {
      await loadJobRuns();
    });

    runJobBtn.addEventListener('click', async () => {
      await runJob();
    });

    saveLabelBtn.addEventListener('click', async () => {
      const token = document.getElementById('token').value.trim();
      const sessionId = selectedSessionInput.value.trim();
      const label = sessionLabel.value.trim();
      if (!sessionId || !label) return;
      await fetch(`/api/v1/admin/chat/sessions/${sessionId}/label`, {
        method: 'POST',
        headers: {
          'Content-Type': 'application/json',
          ...(token ? { Authorization: `Bearer ${token}` } : {})
        },
        body: JSON.stringify({ label })
      });
    });

    loadSessionBtn.addEventListener('click', async () => {
      await loadSessionMessages();
    });

    window.addEventListener('load', async () => {
      const sessions = await fetchSessions();
      renderSessions(sessions);
      await loadAnalytics();
      await loadFlags();
      await loadReviews();
      await loadProfileDiffs();
      await loadJobRuns();
    });
  </script>
</body>
</html>
